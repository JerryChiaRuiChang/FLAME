---
title: "Matching Quality"
author: "Jerry Chia-Rui Chang"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Matching Quality}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, set.seed(500), include=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  cache = T
)

library(FLAME)
```


## Overview of Matching Quality

The FLAME algorithm determines which unimportant covariate to drop based on Matching Quality, consisting of two components - Balancing Factor ($BF$) and Predictive Error ($PE$). Given a list of covariate subsets at a specific iteration, the algorithm chooses the covariate subset such that it maximizes Matching Quality, computed through $-PE + tradeoff * BF$. Balancing factor assesses the proportion of units that can be matched. Predictive error evaluates the predictive quality of current sets of covariates, built upon machine learning algorithms such as ridge regression, LASSO, and decision tree. In short, matching quality is a bias-variance tradeoff between producing more matched groups and having better prediction.  

The implementation of the FLAME algorithm allows users to choose both tradeoff parameter and statistical model that computes predictive error. First, users who prefer covariate subset that produces more matched units should choose higher tradeoff parameter, whereas users who prefer covariate subset that produces better predictive accuracy should choose lower tradeoff parameter. The default tradeoff parameter is set to 0.1. Second, users can choose appropriate statistical model to compute predictive error. The FLAME package currently provides four models; respectively they are Linear Regression, Ridge Regression, LASSO, and Decision Tree. The default model is set to ridge regression with L2 regularization parameter of 0.1. If users would like to use models not supported by the package, they can provide an input R function that computes predictive error.

## Specify models to compute predictive errors

Predictive error ($PE$), in the FLAME algorithm, is defined as the sum of mean squared error for treated units and mean squared error for control units. Denote holdout training set $D^{H} = [X^{H}, Y^{H}, T^{H}]$, where $X^{H}$ represents values of the covariates, $Y^{H}$ is the outcome, and $T^{H}$ indicates whether a unit is in treated group or in control group (1 = treated, 0 = control). Given a predictive model, denote $\hat{Y}^{H}_{u}$ as the predicted value of a unit $u$. The computation of $PE$ is: 

$$
PE = \frac{1}{\sum(1-T^{H}_{u})} \sum_{u:T^{H}_{u} = 0} (Y^{H}_{u} - \hat{Y}^{H}_{u})^2 + \frac{1}{\sum(T^{H}_{u})} \sum_{u:T^{H}_{u} = 1} (Y^{H}_{u} - \hat{Y}^{H}_{u})^2
$$

\newline

We demonstrate how to select various predictive models based on bit vectors implementation. Note that model specification for database systems implementation is the same as bit vectors implementation. We applied `Data_Generation` function to create a synthetic data. There are 1000 treated units and 1000 control units with 10 important covariates and 5 unimportant covariates. Assume holdout training set is the same as the input data.  

```{r, echo=FALSE}
data <- FLAME::Data_Generation(num_control = 1000, num_treated = 1000,
                               num_cov_dense = 10, num_cov_unimportant = 5, U = 5)
holdout <- data 
head(data)
```

### package provided models

1. Linear Regression - R argument requires `model = "Linear"`  
```{r}
linear <- FLAME::FLAME_bit(data = data, holdout = holdout, num_covs = 15, covs_max_list = rep(2,15),
                           model = "Linear")
```

\newline

2. Ridge Regression with L2 regularization parameter of 0.1 - R argument requires `model = "Ridge", ridge_reg = 0.1`  
```{r}
ridge <- FLAME::FLAME_bit(data = data, holdout = holdout, num_covs = 15, covs_max_list = rep(2,15),
                           model = "Ridge", ridge_reg = 0.1)
```

\newline

3. Lasso with L1 regularization regularization parameter of 0.1 - R argument requires `model = "Lasso", lasso_reg = 0.1`  
```{r}
lasso <- FLAME::FLAME_bit(data = data, holdout = holdout, num_covs = 15, covs_max_list = rep(2,15),
                           model = "Lasso", lasso_reg = 0.1)
```

\newline

4. Decision Tree with maximum depth of 8 - R argument requires `model = "DecisionTree", tree_depth = 8`  
```{r}
tree <- FLAME::FLAME_bit(data = data, holdout = holdout, num_covs = 15, covs_max_list = rep(2,15),
                           model = "DecisionTree", tree_depth = 8)
```

### user defined model

If users would like to compute predictive error with models not supported by the package, users can provide their own R function. The package requires the input of the function to have four arguments; respectively, they are (1) outcome for treated units (*outcome_treated*), (2) outcome for control units (*outcome_control*), (3) covariate values for treated units in a matrix form (*covs_treated*), and (4) covariate values for control units in a matrix form (*covs_control*). The function should compute MSE for treated units with argument (1) and (3), and MSE for control units with argument (2) and (4). 

We wrote a R function that computes predictive error based on support vector machine (SVM). The function is called `SVM_PE` based on SVM model in `e1071` package.
```{r}
SVM_PE <- function(outcome_treated, outcome_control, covs_treated, covs_control) {
  
  library(e1071) #load e1071 library
  
  # MSE for treated
  model_svm <- svm(outcome_treated ~ covs_treated) # fit the data to SVM model
  pred_treated <- predict(model_svm, covs_treated) #get predicted values
  MSE_treated <- sum((outcome_treated - pred_treated)^2)/length(outcome_treated) # compute mean squared error
  
  # MSE for control
  model_svm <- svm(outcome_control ~ covs_control) # fit the data to SVM model
  pred_control <- predict(model_svm, covs_control) #get predicted values
  MSE_control <- sum((outcome_control - pred_control)^2)/length(outcome_control) # compute mean squared error
  
  return(MSE_treated + MSE_control)
}
```

\newline

Apply the model as `PE_function = SVM_PE` to the package.
```{r}
SVM <- FLAME::FLAME_bit(data = data, holdout = holdout, num_covs = 15, covs_max_list = rep(2,15), 
                        PE_function = SVM_PE)
```

