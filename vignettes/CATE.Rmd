---
title: "Get Detailed Information After Matching"
author: "Jerry Chia-Rui Chang"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Get Detailed Information After Matching}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE, cache=TRUE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
 set.seed(500)
library(FLAME)
```

This vignette demonstrates how to get detailed information such as conditional average treatment effect (CATE) and average treatment effect (ATE) from the `FLAME` package after matching.

## Setup

First, we applied `Data_Generation` function to generate 1000 treated units and 1000 control units, where U = 5 with 10 important covariates and 5 unimportant covariates. Assume holdout training data is the same as input data. Second, we ran `FLAME_bit` function for matching.

```{r}
data <- FLAME::Data_Generation(num_control = 1000, num_treated = 1000,
                               num_cov_dense = 10, num_cov_unimportant = 5, U = 5)
holdout <- data #Assume holdout training data is the same as input data
result_bit <- FLAME::FLAME_bit(data = data, holdout = holdout, num_covs = 15, covs_max_list = rep(2,15))
```

## Conditional Average Treatment Effect (CATE)

We can get each matched group's conditional average treatment effect (CATE) and other related information from functions `CATE`, `MATCH`, and `CATE_AVG`. Let's use an example when the FLAME algorithm performs matching with 8 covariates at a particular iteration. These 8 covariates are as below.  
```{r, echo=FALSE}
result_bit[[1]][[8]]
```

**a.**   
If we want to see all matched groups at this iteration, apply `CATE` function to get the summary by providing inputs including (1) object returned by applying the FLAME matching algorithm, and (2) number of covariates used for matching with argument `num_covs`. Note that if there is no matched group, `CATE` function will return nothing.  
```{r}
head(FLAME::CATE(FLAME_object = result_bit, num_covs  = 8)) 
```


Let's look at one of the matched groups. This matched group has the following covariate combination.  
```{r, echo=FALSE}
cov_df <- as.matrix(result_bit[[2]][[8]][1,])
cov_name = colnames(cov_df)[1:8]
cov_val = as.vector(cov_df[1,1:8])
cov_df[,1:8]
```

\newline

**b.**  
If we want to see the conditional average treatment effect and matched size of this covariate combination, apply `CATE` function by providing inputs including (1) object returned by applying the FLAME matching algorithm, (2) number of covariates used for matching with argument `num_covs`, (3) covariate names with argument `cov_name`, and (4) corresponding covariate values with argument `cov_val` (Note that covariate values have to be *character* R data type).  
```{r}
#covariate names
cov_name 

#covariate values in character R data type
cov_val 

FLAME::CATE(FLAME_object = result_bit, num_covs  = 8, cov_name = cov_name,cov_val = cov_val)
```

\newline

**c.**  
If we to know which observations/units produce this covariate combination, apply `MATCH` function with three inputs including (1) object returned by applying the FLAME matching algorithm, (2) covariate names with argument `cov_name`, and (3) corresponding covariate values with argument `cov_val` (Note that covariates values have to be *character* R data type).  
```{r}
FLAME::MATCH(FLAME_object = result_bit, cov_name = cov_name, cov_val = cov_val)
```


\newline  

**c.** 
Assume we want to see all matched groups containing the covariate combination **x1 = 1, x3 = 0, x5 = 1, x7 = 0, x9 = 1**. Specifically, even when the FLAME algorithm performs matching with more than 5 covariates, we can still apply `CATE` function to output all possible matches as long as it contains the specified covariate combination. The input requirements are the same as (b), but `num_covs` argument does not need to be specified.

```{r}
CATE_object <- CATE(FLAME_object = result_bit, 
                    cov_name = c("x1", "x3", "x5", "x7", "x9"), 
                    cov_val = c("1", "0", "1", "0", "1"))
CATE_object
```

\newline

**e.**  
We can compute estimated treatment effects of all matched groups in (d) with `AVG_EFFECT` function. Note that estimated treatment effect is the weighted average of CATEs, with weight being the number of units in each matched group. In addition, we can visualize the distribution of all CATEs in boxplot by applying `CATE_plot` function.
```{r}
# Estimated treatment effects 
AVG_EFFECT(CATE_object) 

CATE_plot(CATE_object)
```

## Average Treatment Effect (ATE) and Summary Visualization  

We can compute average treatment effect for each given sub-population by a weighted average of the estimated treatment effects in each matched group. The weight is the number of units in each matched group.
```{r}
FLAME::ATE(result_bit)
```

\newline

Apply `summary_plot` function to visualize the process of matching as the algorithm drops covariate iteratively. The x-axis is the covariate dropped at each iteration. The y-axis on the left is the number of units matched, and the y-axis on the right is the estimated treatment effects. Note that since all covariates are used for matching in the beginning, no covariate is dropped and is represented by NA in the covariate dropped axis. 
```{r}
FLAME::summary_plot(result_bit)
```
