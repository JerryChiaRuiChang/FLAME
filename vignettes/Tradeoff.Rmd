---
title: "Effect of Tradeoff Parameter"
author: "Jerry Chia-Rui Chang"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Effect of Tradeoff Parameter}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, set.seed(333), include=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  cache = T
)

library(FLAME)
library(ggplot2)
library(ggpubr)
```


We explore how the tradeoff parameter affects matching quality. We created a simulated data with 15,000 control units and 15,000 treated units, where variables that are more important to outcome prediction are less balanced. There are 20 covariates with $x_{i} \sim Bernoulli(0.1 + \frac{3i}{190})$ for the control group and $x_{i} \sim Bernoulli(0.9 - \frac{3i}{190})$ for the treated group. The outcome variable is given by $y = \sum_{i = 1}^{20} \frac{1}{i}x_{i}+10T$, where $T \in {0, 1}$ is the treatment indicator. We expect that the algorithm would choose covariate subset that yields higher balancing factor for larger tradeoff parameter.  


```{r, echo = FALSE}
control_random <- function(i) {
  rbinom(15000,1, 0.1 + 3*i/190)
}

treated_random <- function(i) {
  rbinom(15000,1, 0.9 - 3*i/190)
}

outcome <- function(lst) {
  return(sapply(1:20, function(x) 1/x) %*% lst[1:20] + 10 * lst[21])
}

treated_x <- sapply(1:20, treated_random)
treated_y <- apply(cbind(treated_x,rep(1, 15000)), 1, outcome)
treated_x <- apply(treated_x, 2, as.character)

control_x <- sapply(1:20, control_random)
control_y <- apply(cbind(control_x, rep(0, 15000)), 1, outcome)
control_x <- apply(control_x, 2, as.character)

data <- as.data.frame(rbind(as.matrix(cbind(treated_x, as.numeric(treated_y), rep('1', 15000))), 
                            as.matrix(cbind(control_x, as.numeric(control_y), rep('0', 15000)))))
colnames(data) <- c(paste("x",seq(1,20), sep = ""), "outcome","treated")
data[,'outcome'] <- as.numeric(as.character(data[,"outcome"]))
head(data)
```

\newline

We ran the experiment with three distinct tradeoff parameters - 0.1, 0.5, and 1.  
```{r, results="hide"}
#Connect to PostgreSQL
drv <- dbDriver('PostgreSQL')

#Name the connection as db
db <- dbConnect(drv, user="postgres", dbname="FLAME", host='localhost',
             port=5432, password = 'new_password')

#Run FLAME_PostgreSQL 
ridge_1 <- FLAME::FLAME_PostgreSQL(db = db, data = data, holdout = data, num_covs = 20, tradeoff = 0.1)
ridge_5 <- FLAME::FLAME_PostgreSQL(db = db, data = data, holdout = data, num_covs = 20, tradeoff = 0.5)
ridge_10 <- FLAME::FLAME_PostgreSQL(db = db, data = data, holdout = data, num_covs = 20, tradeoff = 1)

#Disconnect from db
dbDisconnect(db)
```

\newline

We examined the percentage of units being matched as the algorithm eliminates covariates. The x-axis denotes the number of remaining covariates, and y-axis denotes the percentage of units matched (cumulative). Larger tradeoff parameter yields more matched units.  
```{r, echo = FALSE}
plot1_tradeoff <- function(FLAME_object, tradeoff) {
  return_df <- FLAME_object[[4]]
  num_cov_remain <- sort(unique(return_df$matched),decreasing = TRUE)
  num_cov_remain <- num_cov_remain[num_cov_remain != 0]
  percent_matched <- sapply(num_cov_remain, function(x) nrow(return_df[return_df$matched >= x,])/30000)
  
  plot_data <- data.frame(cbind(num_cov_remain, percent_matched))
  ggplot(plot_data, aes(reorder(num_cov_remain, percent_matched), percent_matched, group = 1)) + geom_line() + 
  geom_point() + xlab("Num. of Covariates Remaining") + ylab("% of Units Matched") + ylim(0,1) + 
    ggtitle(paste("Tradeoff = ", tradeoff, sep = ""))
}

plot1_1 <- plot1_tradeoff(ridge_1,0.1)
plot1_2 <- plot1_tradeoff(ridge_5,0.5)
plot1_3 <- plot1_tradeoff(ridge_10,1)


ggarrange(plot1_1, plot1_2, plot1_3, ncol = 3, nrow = 1)
```


\newline

We also examined the effect of tradeoff parameter on estimated treatment effect. The x-axis denotes the number of remaining covariates, and y-axis denotes the estimated treatment effect. The bias increases as tradeoff parameter increases.

```{r, echo=FALSE}
plot2_tradeoff <- function(FLAME_object, tradeoff) {
  return_df <- FLAME_object[[4]]
  num_cov_remain <- sort(unique(return_df$matched),decreasing = TRUE)
  num_cov_remain <- num_cov_remain[num_cov_remain != 0]
  size <- sapply(num_cov_remain, function(x) nrow(return_df[return_df$matched >= x,]))
  Est_TE <- sapply(num_cov_remain, function(x) AVG_EFFECT(FLAME_object[[2]][1:which(num_cov_remain == x)]))

  
  plot_data <- data.frame(x = num_cov_remain, y = Est_TE, matched_size = size)
  plot_data$x <- factor(plot_data$x, levels = plot_data$x[order(plot_data$x, decreasing = TRUE)])
  
  
  ggplot(plot_data, aes(x, y)) + geom_point(aes(size =  matched_size)) + 
    xlab("Num. of Covariates Remaining") + ylab("Estimated Treatment Effect") + ylim(8,14) + 
    ggtitle(paste("Tradeoff = ", tradeoff, sep = "")) + theme(legend.position="none")
}

plot2_1 <- plot2_tradeoff(ridge_1,0.1)
plot2_2 <- plot2_tradeoff(ridge_5,0.5)
plot2_3 <- plot2_tradeoff(ridge_10,1)

ggarrange(plot2_1, plot2_2, plot2_3, ncol = 3, nrow = 1)
```

\newline

In summary, tradeoff parameter is the tradeoff between finding more matched units (higher balancing factor) and having lower bias (lower predictive error). In the summary plot below, the x-axis denotes the percentage of units matched, and the y-axis denotes the estimated treatment effect.

```{r, echo=FALSE}
plot3_tradeoff <- function(FLAME_object, tradeoff){
  return_df <- FLAME_object[[4]]
  num_cov_remain <- sort(unique(return_df$matched),decreasing = TRUE)
  num_cov_remain <- num_cov_remain[num_cov_remain != 0]
  Est_TE <- sapply(num_cov_remain, function(x) AVG_EFFECT(FLAME_object[[2]][1:which(num_cov_remain == x)]))
  percent_matched <- sapply(num_cov_remain, function(x) nrow(return_df[return_df$matched >= x,])/30000)

  plot_data <- data.frame(x = percent_matched, y = Est_TE)
  
  ggplot(plot_data, aes(x, y)) + geom_point() + xlim(0,1) + ylim(8,14) +
    ylab("Estimated Treatment Effect") + xlab("% of Units Matched")  + 
    ggtitle(paste("Tradeoff = ", tradeoff, sep = "")) 
}
  
plot3_1 <- plot3_tradeoff(ridge_1,0.1)
plot3_2 <- plot3_tradeoff(ridge_5,0.5)
plot3_3 <- plot3_tradeoff(ridge_10,1)


ggarrange(plot3_1, plot3_2, plot3_3, ncol = 3, nrow = 1)
```
